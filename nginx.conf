daemon off;
worker_processes  4;
events { worker_connections 1024; }
http {
  include /etc/nginx/mime.types;

  log_format eb_log '$http_x_forwarded_for - $remote_user [$time_local] ' '"$request" $status $body_bytes_sent "$http_referer" ' '"$http_user_agent"' ;

  client_max_body_size 100M;

  upstream app {
    server web:3000;
    keepalive 4;
  }

  server {
    listen 81 default_server;

    location /_healthcheck {
      proxy_pass http://app/_healthcheck;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection "";
      proxy_http_version 1.1;
    }

    location / {
      return 404;
    }
  }

  server {
    listen 80 default_server;

    location /_healthcheck {
      proxy_pass http://app/_healthcheck;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection "";
      proxy_http_version 1.1;
    }

    location / {
      return 404;
    }
  }

  server {
    listen 81;
    server_name versobooks.com *.versobooks.com sevenstories.com *.sevenstories.com haymarketbooks.org *.haymarketbooks.org *.positiondevapp.com *.us-east-1.elasticbeanstalk.com;
    include server_81.conf;
  }

  server {
      listen 80;
      server_name haymarketbooks.org *.haymarketbooks.org haymarket-staging.positiondevapp.com;

      rewrite ^/pb/Men-Explain-Things-to-Me$ /books/612-men-explain-things-to-me permanent;
      rewrite ^/pb/From-BlackLivesMatter-to-Black-Liberation$ /books/778-from-blacklivesmatter-to-black-liberation permanent;
      rewrite ^/pb/Freedom-Is-a-Constant-Struggle$ /books/780-freedom-is-a-constant-struggle permanent;
      rewrite ^/pb/The-Noam-Chomsky-Collection$ /authors/28-noam-chomsky permanent;
      rewrite ^/haymarket/new$ /books permanent;
      rewrite ^/contact$ /pg/about permanent;
      rewrite ^/haymarket/forthcoming$ /books?sort=forthcoming&sort_dir=asc#browse permanent;
      rewrite ^/pb/Socialism-Seriously$ /books/740-socialism-seriously permanent;
      rewrite ^/about$ /pg/about permanent;
      rewrite ^/category/marxism-and-socialism$ /books/subjects/36-socialism-amp-marxism permanent;
      rewrite ^/pb/Blackwater-El-Auge-del-Ej-rcito-Mercenario-m-s-Poderoso-del-Mundo$ /books/861-blackwater-espanol permanent;
      rewrite ^/pb/Tomas-Youngs-War$ /books/961-tomas-young-s-war permanent;
      rewrite ^/user$ /users/sign_in permanent;
      rewrite ^/pb/Year-501$ /books/633-year-501 permanent;
      rewrite ^/category/hm-series$ /series_collections/1-historical-materialism permanent;
      rewrite ^/pb/The-BreakBeat-Poets$ /books/621-the-breakbeat-poets permanent;
      rewrite ^/pb/The-Long-Depression$ /books/693-the-long-depression permanent;
      rewrite ^/pb/The-Washington-Connection-and-Third-World-Fascism$ /books/632-the-washington-connection-and-third-world-fascism permanent;
      rewrite ^/pb/Europe-in-Revolt$ /books/1015-europe-in-revolt permanent;
      rewrite ^/category/economics$ /books/subjects/31-economics permanent;
      rewrite ^/hc/Uncivil-Rites$ /books/792-uncivil-rites permanent;
      rewrite ^/hc/Tomas-Youngs-War$ /books/961-tomas-young-s-war permanent;
      rewrite ^/category/racism-and-civil-rights$ /books/subjects/13-black-politics permanent;
      rewrite ^/pb/Vive-la-Revolution-A-Stand-up-History-of-the-French-Revolution$ /books/836-vive-la-revolution permanent;
      rewrite ^/pb/Things-That-Can-and-Cannot-Be-Said$ /books/1013-things-that-can-and-cannot-be-said permanent;
      rewrite ^/pb/Apartheid-Israel$ /books/742-apartheid-israel permanent;
      rewrite ^/pb/China-on-Strike$ /books/746-china-on-strike permanent;
      rewrite ^/pb/Hope-in-the-Dark$ /books/791-hope-in-the-dark permanent;
      rewrite ^/pb/Propaganda-and-the-Public-Mind-0$ /books/628-propaganda-and-the-public-mind permanent;
      rewrite ^/pb/The-Politics-of-Che-Guevara$ /books/902-the-politics-of-che-guevara permanent;
      rewrite ^/category/labor$ /books/subjects/40-labor-movement permanent;
      rewrite ^/contact/general$ /pg/about permanent;
      rewrite ^/pb/The-Battle-for-Justice-in-Palestine$ /books/554-the-battle-for-justice-in-palestine permanent;
      rewrite ^/category/globalization-and-imperialism$ /books/subjects/34-imperialism-amp-war permanent;
      rewrite ^/pb/Women-and-Socialism-Revised-and-Updated-Edition$ /books/423-women-and-socialism-revised-and-updated-edition permanent;
      rewrite ^/contact/submissions$ /pg/about permanent;
      rewrite ^/pb/Capitalism$ /books/611-capitalism permanent;
      rewrite ^/pb/The-End-of-Imagination$ /books/953-the-end-of-imagination permanent;
      rewrite ^/pb/The-Democrats-Updated-Edition$ /books/431-the-democrats permanent;
      rewrite ^/pb/Oranges-in-No-Mans-Land$ /books/855-oranges-in-no-man-s-land permanent;
      rewrite ^/category/us-history-politics$ /books/subjects/41-u-s-history-amp-politics permanent;
      rewrite ^/haymarket/all$ /books?sort=title&sort_dir=asc#browse permanent;
      rewrite ^/pb/Splinterlands$ /books/1039-splinterlands permanent;
      rewrite ^/hc/Long-Shot-0$ /books/964-long-shot permanent;

      ##
      # First regex set is to capture URLs that have `-0` at the end and remove them from the search string
      # Second set is the standard captures without a `-0`
      ##
      rewrite ^/pb/(.+?)(?=-0)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
      rewrite ^/hc/(.+?)(?=-0)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
      rewrite ^/bio/(.+?)(?=-0)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
      rewrite ^/category/(.+?)(?=-0)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;

      rewrite ^/pb/(.*)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
      rewrite ^/hc/(.*)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
      rewrite ^/bio/(.*)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
      rewrite ^/category/(.*)$ https://www.haymarketbooks.org/search?utf8=%E2%9C%93&q=$1&commit=Submit last;

      include server_80.conf;
  }

  server {
    listen 80;
    server_name versobooks.com *.versobooks.com sevenstories.com *.sevenstories.com *.positiondevapp.com *.us-east-1.elasticbeanstalk.com;
    include server_80.conf;
  }

  server {
    listen 80;
    server_name catalog.sevenstories.com ssp-staging-catalog.positiondevapp.com;

    rewrite ^/products/(.*)$ https://www.sevenstories.com/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
    rewrite ^/collections/(.*)$ https://www.sevenstories.com/search?utf8=%E2%9C%93&q=$1&commit=Submit last;
    rewrite ^.*$ https://www.sevenstories.com last;

    return 404;
  }

}
